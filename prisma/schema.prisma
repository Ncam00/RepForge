generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  weights         Weight[]
  weightGoal      WeightGoal?
  workoutSplits   WorkoutSplit[]
  sessions        WorkoutSession[]
  exercises       Exercise[]
  personalRecords PersonalRecord[]
  settings        UserSettings?
  templates       WorkoutTemplate[]
  JournalEntry    JournalEntry[]

  @@map("users")
}

model Weight {
  id         String   @id @default(cuid())
  userId     String
  weight     Float
  unit       String   @default("kg") // kg or lbs
  bodyFat    Float? // body fat percentage
  muscleMass Float? // muscle mass in kg or lbs
  date       DateTime @default(now())
  notes      String?
  photoUrl   String? // progress photo
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@map("weights")
}

model WeightGoal {
  id           String    @id @default(cuid())
  userId       String    @unique
  targetWeight Float
  unit         String    @default("kg")
  targetDate   DateTime?
  startWeight  Float
  startDate    DateTime  @default(now())
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("weight_goals")
}

model WorkoutSplit {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  days SplitDay[]

  @@index([userId])
  @@map("workout_splits")
}

model SplitDay {
  id             String  @id @default(cuid())
  workoutSplitId String
  dayOfWeek      Int // 0-6 (Sunday-Saturday)
  name           String // e.g., "Push", "Pull", "Legs"
  description    String?
  order          Int     @default(0)

  workoutSplit WorkoutSplit       @relation(fields: [workoutSplitId], references: [id], onDelete: Cascade)
  exercises    SplitDayExercise[]

  @@index([workoutSplitId])
  @@map("split_days")
}

model Exercise {
  id           String   @id @default(cuid())
  userId       String? // null for system exercises
  name         String
  description  String?
  videoUrl     String?
  muscleGroups String // JSON array of muscle groups
  equipment    String?
  difficulty   String? // beginner, intermediate, advanced
  instructions String?
  tips         String?
  isPublic     Boolean  @default(false)
  isFavorite   Boolean  @default(false)
  category     String? // compound, isolation, cardio, etc.
  variations   String? // JSON array of variation exercise IDs
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user              User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  splitDayExercises SplitDayExercise[]
  sets              ExerciseSet[]
  personalRecords   PersonalRecord[]
  templateExercises TemplateExercise[]

  @@index([userId])
  @@index([muscleGroups])
  @@map("exercises")
}

model SplitDayExercise {
  id         String  @id @default(cuid())
  splitDayId String
  exerciseId String
  order      Int     @default(0)
  targetSets Int?
  targetReps String? // e.g., "8-12" or "10"
  restTime   Int? // seconds
  notes      String?

  splitDay SplitDay @relation(fields: [splitDayId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([splitDayId])
  @@index([exerciseId])
  @@map("split_day_exercises")
}

model WorkoutSession {
  id          String    @id @default(cuid())
  userId      String
  name        String?
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  duration    Int? // minutes
  notes       String?
  mood        String? // good, average, poor
  energyLevel Int? // 1-10

  user User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sets ExerciseSet[]

  @@index([userId, startedAt])
  @@map("workout_sessions")
}

model ExerciseSet {
  id               String   @id @default(cuid())
  workoutSessionId String
  exerciseId       String
  setNumber        Int
  weight           Float?
  reps             Int?
  rpe              Float? // Rate of Perceived Exertion (1-10)
  restTime         Int? // seconds
  isWarmup         Boolean  @default(false)
  notes            String?
  completedAt      DateTime @default(now())

  session  WorkoutSession @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  exercise Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([workoutSessionId])
  @@index([exerciseId])
  @@map("exercise_sets")
}

model PersonalRecord {
  id         String   @id @default(cuid())
  userId     String
  exerciseId String
  recordType String // one_rep_max, max_volume, max_reps
  value      Float
  date       DateTime @default(now())
  notes      String?

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([userId, exerciseId])
  @@map("personal_records")
}

model UserSettings {
  id             String   @id @default(cuid())
  userId         String   @unique
  weightUnit     String   @default("lbs") // lbs or kg
  theme          String   @default("light") // light or dark
  notifications  Boolean  @default(true)
  restTimerSound Boolean  @default(true)
  autoStartTimer Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model WorkoutTemplate {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  isPublic    Boolean  @default(false)
  category    String? // strength, cardio, hiit, etc.
  difficulty  String? // beginner, intermediate, advanced
  duration    Int? // estimated minutes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercises TemplateExercise[]

  @@index([userId])
  @@index([isPublic])
  @@map("workout_templates")
}

model TemplateExercise {
  id         String  @id @default(cuid())
  templateId String
  exerciseId String
  order      Int     @default(0)
  sets       Int?
  reps       String? // e.g., "8-12" or "10"
  restTime   Int? // seconds
  notes      String?

  template WorkoutTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  exercise Exercise        @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([exerciseId])
  @@map("template_exercises")
}

model JournalEntry {
  id           String   @id @default(cuid())
  userId       String
  date         DateTime @default(now())
  title        String?
  content      String?
  mood         String? // great, good, okay, bad, terrible
  energyLevel  Int? // 1-10
  sleepQuality Int? // 1-10
  bodyWeight   Float?
  notes        String?
  tags         String? // JSON array
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@map("journal_entries")
}

// Social Features

model Follow {
  id          String   @id @default(cuid())
  followerId  String // User who is following
  followingId String // User being followed
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model WorkoutShare {
  id        String   @id @default(cuid())
  userId    String
  sessionId String
  caption   String?
  isPublic  Boolean  @default(true)
  likes     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isPublic, createdAt])
  @@map("workout_shares")
}

model Like {
  id      String   @id @default(cuid())
  userId  String
  shareId String
  createdAt DateTime @default(now())

  @@unique([userId, shareId])
  @@index([shareId])
  @@map("likes")
}

model Comment {
  id        String   @id @default(cuid())
  userId    String
  shareId   String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shareId])
  @@index([userId])
  @@map("comments")
}

model Achievement {
  id          String   @id @default(cuid())
  userId      String
  type        String // first_workout, 10_workouts, 100_workouts, pr_set, streak_7, etc.
  title       String
  description String
  icon        String? // emoji or icon name
  unlockedAt  DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@map("achievements")
}

model Leaderboard {
  id        String   @id @default(cuid())
  userId    String
  category  String // total_volume, total_workouts, streak, etc.
  value     Float
  rank      Int?
  period    String // weekly, monthly, all_time
  startDate DateTime
  endDate   DateTime
  updatedAt DateTime @updatedAt

  @@unique([userId, category, period, startDate])
  @@index([category, period, value])
  @@map("leaderboards")
}

// Gamification System
model UserProgress {
  id              String   @id @default(cuid())
  userId          String   @unique
  xp              Int      @default(0)
  level           Int      @default(1)
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastWorkoutDate DateTime?
  totalXpEarned   Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("user_progress")
}

model XpTransaction {
  id        String   @id @default(cuid())
  userId    String
  amount    Int
  reason    String
  source    String // workout_complete, pr_set, streak_bonus, challenge_complete
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@map("xp_transactions")
}

model Challenge {
  id          String    @id @default(cuid())
  userId      String
  type        String // daily, weekly, custom
  title       String
  description String
  target      Int
  progress    Int       @default(0)
  xpReward    Int
  status      String    @default("active") // active, completed, expired
  startDate   DateTime  @default(now())
  endDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, status])
  @@map("challenges")
}
